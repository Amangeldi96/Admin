<!DOCTYPE html>
<html lang="ky">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MusicKG Admin - Native Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1db954;
            --danger: #ff1744;
            --bg: #0c0c0c;
            --card: #181818;
            --input-bg: #222222;
            --text: #ffffff;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; padding: 20px; overflow-x: hidden;
        }

        /* Плавно жылган прогресс баскычы */
        .btn-send { 
            position: relative; width: 100%; background: #ffffff; 
            color: #000; font-weight: 700; padding: 18px; 
            border-radius: 14px; border: 2px solid var(--primary); font-size: 16px;
            margin-top: 15px; cursor: pointer; overflow: hidden;
            text-align: center;
        }
        .progress-fill {
            position: absolute; top: 0; left: 0; height: 100%;
            width: 0%; background: var(--primary); z-index: 1;
            /* Плавный эффект үчүн transition убактысын бир аз узарттык */
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-text { position: relative; z-index: 2; }

        .toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            padding: 15px 30px; border-radius: 50px; font-weight: 600;
            z-index: 10000; transition: top 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); text-align: center;
        }
        .toast.show { top: 30px; }

        .category-header {
            display: flex; align-items: center; margin: 30px 0 15px 0; padding-left: 12px;
            border-left: 4px solid var(--primary);
        }
        .category-header h3 { margin: 0; font-size: 14px; text-transform: uppercase; color: #888; }

        .swipe-container {
            position: relative; background: var(--danger);
            border-radius: 16px; margin-bottom: 10px; overflow: hidden; height: 70px;
        }
        .item { 
            background: var(--card); height: 100%; display: flex; align-items: center; 
            padding: 0 20px; position: absolute; top: 0; left: 0; width: 100%;
            box-sizing: border-box; z-index: 2; transition: transform 0.4s ease;
            border: 1px solid #222;
        }
        .delete-btn { 
            position: absolute; right: 0; width: 85px; height: 100%;
            display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold;
        }

        .modal {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
            backdrop-filter: blur(15px); align-items: center; justify-content: center;
        }
        .modal-content {
            background: #111; width: 90%; max-width: 400px; padding: 30px;
            border-radius: 24px; border: 1px solid #333; position: relative;
        }
        .close-x {
            position: absolute; top: 15px; right: 15px; width: 35px; height: 35px; 
            background: #222; border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; color: white; cursor: pointer;
        }

        input, select { 
            width: 100%; padding: 16px; margin: 8px 0; background: var(--input-bg); 
            border-radius: 12px; border: 1px solid #333; color: white; box-sizing: border-box; outline: none;
        }
        .custom-file-upload {
            display: block; background: #1a1a1a; border: 1px dashed #444; 
            color: #888; padding: 15px; border-radius: 12px; text-align: center; margin: 10px 0;
        }
        .add-btn { 
            position: fixed; right: 25px; bottom: 25px; background: var(--primary); 
            width: 60px; height: 60px; border-radius: 50%; color: black; font-size: 30px; 
            border: none; z-index: 1000; box-shadow: 0 5px 20px rgba(29, 185, 84, 0.4);
        }
    </style>
</head>
<body>

<div id="toast-box" class="toast"></div>

<div id="login-screen">
    <div class="login-box">
        <h2 style="text-align: center;">MusicKG Admin</h2>
        <input type="email" id="email-in" placeholder="Email">
        <input type="password" id="pass-in" placeholder="Пароль">
        <button class="btn-send" onclick="login()"><span class="btn-text">Кирүү</span></button>
    </div>
</div>

<div id="admin-main" style="display:none;">
    <h2>Башкаруу</h2>
    <div id="lists-container">
        <div class="category-header"><h3>Шортс</h3></div><div id="list-shorts"></div>
        <div class="category-header"><h3>Топ 5</h3></div><div id="list-top_hits"></div>
        <div class="category-header"><h3>Хиттер</h3></div><div id="list-hits"></div>
        <div class="category-header"><h3>Жаңы</h3></div><div id="list-new_hits"></div>
        <div class="category-header"><h3>Күтүлүүдө</h3></div><div id="list-upcoming"></div>
    </div>
    <button class="add-btn" onclick="openUpload()">+</button>
</div>

<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="close-x" onclick="closeUpload()">✕</div>
        <h3 style="text-align: center;">Жүктөө</h3>
        <select id="mainCategory" onchange="adjustForm()">
            <option value="shorts">Шортс (Видео)</option>
            <option value="top_hits">Топ 5 жаңы ырлар</option>
            <option value="hits">Хит ырлар</option>
            <option value="new_hits">Жаңы хитер</option>
            <option value="upcoming">Жакында чыгуучу</option>
        </select>
        <input type="text" id="artistName" placeholder="Артисттин аты">
        <input type="text" id="itemName" placeholder="Аталышы">
        <div id="fileFields"></div>
        <button class="btn-send" id="uploadBtn" onclick="confirmUpload()">
            <div class="progress-fill" id="upload-progress"></div>
            <span class="btn-text" id="upload-btn-text">Сайтка чыгаруу</span>
        </button>
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <div class="close-x" onclick="closeDelModal()">✕</div>
        <h3 style="color: var(--danger);">Өчүрүлсүнбү?</h3>
        <button class="btn-send" style="border-color: var(--danger); background: #000; color: #fff;" id="confirmDeleteBtn">
            <span class="btn-text">Ооба, өчүрүү</span>
        </button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBVhHADTsrD2e2tKXEtJ-M1EOUHv8qREuw",
        authDomain: "musickg-36f9f.firebaseapp.com",
        projectId: "musickg-36f9f",
        storageBucket: "musickg-36f9f.firebasestorage.app",
        messagingSenderId: "718433313457",
        appId: "1:718433313457:web:bb6906c7108adcb01d3890"
    };

    const B2_CONFIG = {
        keyID: "00558a7e016035d0000000003", 
        appKey: "K0057L49xqU5qdZtaHqft5bQEjpjxz0", 
        bucketId: "6528aac73e80217690c3051d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function showMsg(text, isError = false) {
        const t = document.getElementById('toast-box');
        t.innerText = text;
        t.style.background = isError ? 'var(--danger)' : 'var(--primary)';
        t.style.color = isError ? '#fff' : '#000';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    async function getB2UploadParams() {
        const authBase64 = btoa(`${B2_CONFIG.keyID}:${B2_CONFIG.appKey}`);
        
        const authRes = await fetch('https://api.backblazeb2.com/b2api/v2/b2_authorize_account', {
            headers: { 'Authorization': `Basic ${authBase64}` }
        });
        if (!authRes.ok) throw new Error("B2 Auth Failed");
        const authData = await authRes.json();

        const urlRes = await fetch(`${authData.apiUrl}/b2api/v2/b2_get_upload_url`, {
            method: 'POST',
            headers: { 'Authorization': authData.authorizationToken },
            body: JSON.stringify({ bucketId: B2_CONFIG.bucketId })
        });
        if (!urlRes.ok) throw new Error("B2 Get URL Failed");
        const urlData = await urlRes.json();

        return {
            uploadUrl: urlData.uploadUrl,
            uploadToken: urlData.authorizationToken,
            downloadUrl: authData.downloadUrl
        };
    }

    function uploadToB2(file, onProg) {
        return new Promise(async (resolve, reject) => {
            try {
                const params = await getB2UploadParams();
                // ASCII гана калтырып файл атын тазалоо (B2 400 ката бербеши үчүн)
                const safeName = Date.now() + "_" + file.name.replace(/[^\x00-\x7F]/g, "").replace(/\s+/g, "_");
                
                const xhr = new XMLHttpRequest();
                xhr.open('POST', params.uploadUrl);
                
                xhr.setRequestHeader('Authorization', params.uploadToken);
                xhr.setRequestHeader('X-Bz-File-Name', encodeURIComponent(safeName));
                xhr.setRequestHeader('Content-Type', file.type || 'b2/x-auto');
                xhr.setRequestHeader('X-Bz-Content-Sha1', 'do_not_verify');

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const currentP = Math.round((e.loaded / e.total) * 100);
                        onProg(currentP);
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        const res = JSON.parse(xhr.responseText);
                        resolve({ 
                            url: `${params.downloadUrl}/file/Musickg/${res.fileName}`, 
                            name: res.fileName 
                        });
                    } else {
                        reject(`B2 Error: ${xhr.status}`);
                    }
                };
                xhr.onerror = () => reject('Тармак катасы');
                xhr.send(file);

            } catch (err) {
                reject(err.message || 'Жүктөө катасы');
            }
        });
    }

    window.confirmUpload = async () => {
        const cat = document.getElementById('mainCategory').value;
        const name = document.getElementById('itemName').value;
        const artist = document.getElementById('artistName').value;
        const btn = document.getElementById('uploadBtn');
        const prog = document.getElementById('upload-progress');
        const txt = document.getElementById('upload-btn-text');
        const files = Array.from(document.querySelectorAll('input[type="file"]')).filter(f => f.files[0]);

        if (!name || files.length === 0) return showMsg("Маалыматты толук толтуруңуз", true);
        
        btn.disabled = true;
        prog.style.width = "0%"; // Башында 0 кылабыз
        
        try {
            let data = { name, artist, createdAt: new Date(), b2Files: [] };
            
            for (let f of files) {
                const res = await uploadToB2(f.files[0], (p) => {
                    prog.style.width = p + "%";
                    txt.innerText = `Жүктөлүүдө: ${p}%`;
                });
                const type = f.accept.split('/')[0];
                data[type + 'Url'] = res.url;
                data.b2Files.push(res.name);
            }

            await addDoc(collection(db, cat), data);
            showMsg("Ийгиликтүү кошулду!");
            setTimeout(() => location.reload(), 1500);
        } catch (e) {
            showMsg(e.message || e, true);
            btn.disabled = false;
            txt.innerText = "Кайра аракет кылуу";
            prog.style.width = "0%";
        }
    };

    // Firebase логикасы жана калган UI функциялары (өзгөрүүсүз калды)
    window.login = () => {
        const e = document.getElementById('email-in').value;
        const p = document.getElementById('pass-in').value;
        signInWithEmailAndPassword(auth, e, p).catch(() => showMsg("Кирүү ката!", true));
    };

    onAuthStateChanged(auth, (u) => {
        if (u) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-main').style.display = 'block';
            loadAllItems();
        }
    });

    async function loadAllItems() {
        const cats = ['shorts', 'top_hits', 'hits', 'new_hits', 'upcoming'];
        for (let c of cats) {
            const list = document.getElementById('list-' + c);
            if (!list) continue;
            list.innerHTML = "";
            const q = query(collection(db, c), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            snap.forEach(d => {
                const data = d.data();
                const html = `
                    <div class="swipe-container" id="${d.id}">
                        <div class="item" ontouchstart="ts(event)" ontouchmove="tm(event)" ontouchend="te(event)">
                            <div style="width:100%">
                                <b style="display:block; font-size:14px;">${data.artist || ''} - ${data.name}</b>
                                <small style="color:#888;">${c}</small>
                            </div>
                        </div>
                        <div class="delete-btn" onclick="askDelete('${c}', '${d.id}')">Өчүрүү</div>
                    </div>`;
                list.insertAdjacentHTML('beforeend', html);
            });
        }
    }

    window.deleteItem = async (cat, id) => {
        const dRef = doc(db, cat, id);
        const snap = await getDoc(dRef);
        await deleteDoc(dRef);
        document.getElementById(id).remove();
        closeDelModal();
        showMsg("Өчүрүлдү");
    }

    window.adjustForm = () => {
        const cat = document.getElementById('mainCategory').value;
        const area = document.getElementById('fileFields');
        area.innerHTML = "";
        const config = {
            shorts: [['Видео', 'video/*']],
            top_hits: [['Аудио', 'audio/*'], ['Сүрөт', 'image/*']],
            upcoming: [['Аудио', 'audio/*'], ['Сүрөт', 'image/*']],
            new_hits: [['Аудио', 'audio/*'], ['Сүрөт', 'image/*']],
            hits: [['Аудио', 'audio/*']]
        };
        config[cat].forEach(t => {
            const id = 'f' + Math.random().toString(36).substr(2,4);
            area.insertAdjacentHTML('beforeend', `
                <label for="${id}" class="custom-file-upload" id="l-${id}">${t[0]} <span>+</span></label>
                <input type="file" id="${id}" accept="${t[1]}" onchange="updateName('${id}')" style="display:none">
            `);
        });
    }

    window.updateName = (id) => {
        const f = document.getElementById(id).files[0];
        if (f) document.getElementById('l-'+id).innerHTML = `Тандалды: <span style="color:var(--primary)">${f.name.substring(0,10)}</span>`;
    }

    let sx = 0, cx = 0, activeEl = null;
    window.ts = (e) => { sx = e.touches[0].clientX; activeEl = e.currentTarget; activeEl.style.transition = 'none'; }
    window.tm = (e) => { 
        cx = e.touches[0].clientX - sx;
        if (cx < 0 && cx > -100) activeEl.style.transform = `translateX(${cx}px)`;
    }
    window.te = () => {
        activeEl.style.transition = 'transform 0.4s ease';
        activeEl.style.transform = (cx < -50) ? 'translateX(-85px)' : 'translateX(0px)';
    }

    let delCat = '', delId = '';
    window.askDelete = (c, i) => { delCat = c; delId = i; document.getElementById('deleteModal').style.display = 'flex'; }
    window.closeDelModal = () => { document.getElementById('deleteModal').style.display = 'none'; }
    document.getElementById('confirmDeleteBtn').onclick = () => window.deleteItem(delCat, delId);

    window.openUpload = () => { document.getElementById('uploadModal').style.display = 'flex'; adjustForm(); }
    window.closeUpload = () => { document.getElementById('uploadModal').style.display = 'none'; }
</script>

</body>
</html>
